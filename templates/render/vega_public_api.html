{% extends "base.html" %}

{% block content %}
<h2>Part 3 Chart: Public API Services by Location (Bar)</h2>
<p>
    ELI5: we ask the public API for service rows, then Vega-Lite groups by location
    and draws the bar chart.
</p>

<p><strong>Data URL:</strong> <code>{{ request.scheme }}://{{ request.get_host }}{% url 'services-api' %}</code></p>

<div id="vis-public-api" style="min-height: 390px;"></div>
<p id="public-api-status" style="margin-top: 8px; color: #b00020; font-weight: 600;"></p>
<noscript><p style="margin-top: 8px; color: #b00020; font-weight: 600;">JavaScript is disabled. Vega-Lite charts require JavaScript.</p></noscript>

<!-- Vega libraries from CDN -->
<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

<script>
  // Same "recipe card" pattern as our other charts.
  // The API returns {"count": ..., "results": [...]}, so we point Vega-Lite at "results".
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Bar chart grouped by location from the public services API.",
    "data": {
      "url": "{% url 'services-api' %}",
      "format": {"property": "results"}
    },
    "mark": {"type": "bar", "color": "#E84A27", "tooltip": true},
    "encoding": {
      "x": {"field": "location", "type": "nominal", "title": "Location", "sort": "-y"},
      "y": {"aggregate": "count", "type": "quantitative", "title": "Number of Services"}
    },
    "width": 760,
    "height": 360,
    "config": {
      "view": {"stroke": "#d7e3f0"},
      "axis": {"labelColor": "#1b2a3a", "titleColor": "#1b2a3a"}
    }
  };

  const statusEl = document.getElementById("public-api-status");
  statusEl.textContent = "Loading chart...";

  if (typeof vegaEmbed === "undefined") {
    statusEl.textContent = "Chart libraries failed to load (CDN blocked or offline).";
  } else {
    vegaEmbed("#vis-public-api", spec, {"actions": false, "renderer": "svg"})
      .then(() => {
        const svg = document.querySelector("#vis-public-api svg");
        if (!svg) {
          statusEl.textContent = "Chart rendered but SVG node was not found.";
          return;
        }
        const w = svg.getAttribute("width");
        const h = svg.getAttribute("height");
        statusEl.textContent = `Rendered chart SVG (${w}x${h}).`;
        setTimeout(() => { statusEl.textContent = ""; }, 1500);
      })
      .catch((error) => {
        statusEl.textContent = `Chart failed: ${error.message}`;
      });
  }
</script>
{% endblock %}
