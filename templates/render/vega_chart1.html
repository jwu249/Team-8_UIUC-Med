{% extends "base.html" %}

{% block content %}
<h2>Chart 1: Services by Location (Bar)</h2>
<p>
    ELI5: we ask our own API "how many services per location?",
    then Vega-Lite draws bars from that answer.
</p>

<p><strong>Data URL:</strong> <code>{% url 'api-summary' %}</code></p>

<div id="vis-chart1" style="min-height: 390px;"></div>
<p id="chart1-status" style="margin-top: 8px; color: #b00020; font-weight: 600;"></p>
<noscript><p style="margin-top: 8px; color: #b00020; font-weight: 600;">JavaScript is disabled. Vega-Lite charts require JavaScript.</p></noscript>

<!-- Vega libraries from CDN -->
<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

<script>
  // Casual explanation:
  // This object is just a "recipe card" telling Vega-Lite what to draw.
  // - data.url: where to fetch JSON
  // - mark: "bar" means bar chart
  // - encoding: what field goes on x and y
  const chartSpec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Bar chart of service counts by location from internal API.",
    "data": {
      "url": "{% url 'api-summary' %}"
    },
    "mark": {"type": "bar", "color": "#E84A27", "tooltip": true},
    "encoding": {
      "x": {"field": "category", "type": "nominal", "title": "Location", "sort": "-y"},
      "y": {"field": "count", "type": "quantitative", "title": "Number of Services"}
    },
    "width": 760,
    "height": 360,
    "config": {
      "view": {"stroke": "#d7e3f0"},
      "axis": {"labelColor": "#1b2a3a", "titleColor": "#1b2a3a"}
    }
  };

  const statusEl = document.getElementById("chart1-status");
  const dataUrl = "{% url 'api-summary' %}";
  statusEl.textContent = "Loading chart...";

  if (typeof vegaEmbed === "undefined") {
    statusEl.textContent = "Chart libraries failed to load (CDN blocked or offline).";
  } else {
    fetch(dataUrl)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`API request failed (${response.status})`);
        }
        return response.json();
      })
      .then((rows) => {
        if (!Array.isArray(rows) || rows.length === 0) {
          statusEl.textContent = "No chart data found. Add MedService rows, then refresh.";
          return;
        }
        return vegaEmbed("#vis-chart1", chartSpec, {"actions": false, "renderer": "svg"})
          .then(() => {
            const svg = document.querySelector("#vis-chart1 svg");
            if (!svg) {
              statusEl.textContent = "Chart rendered but SVG node was not found.";
              return;
            }
            const w = svg.getAttribute("width");
            const h = svg.getAttribute("height");
            statusEl.textContent = `Rendered chart SVG (${w}x${h}).`;
            setTimeout(() => { statusEl.textContent = ""; }, 1500);
          });
      })
      .catch((error) => {
        statusEl.textContent = `Chart failed: ${error.message}`;
      });
  }
</script>
{% endblock %}
